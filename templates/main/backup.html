{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}پشتیبان‌گیری | گردو{% endblock title %}

{% block content %}
<div class="container-xxl flex-grow-1 container-p-y">
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">ایجاد نسخه پشتیبان جدید</h5>
        </div>
        <div class="card-body">
            <form method="POST" action="{% url 'create_backup' %}" class="row g-3">
                {% csrf_token %}
                <div class="col-md-10">
                    <label for="id_description" class="form-label">توضیحات</label>
                    <input type="text"
                           class="form-control"
                           id="id_description"
                           name="description"
                           placeholder="مثلاً: پشتیبان‌گیری ماهیانه"
                    >
                </div>
                <div class="col-md-2 align-self-end">
                    <button type="submit" class="btn btn-success w-100" id="create-backup-btn">
                        <i class="tf-icons bx bx-download me-1"></i>
                        دانلود فایل پشتیبان
                    </button>
                </div>
            </form>
            <small class="text-primary fw-bold mt-2 d-block">
                توجه: با زدن دکمه، یک کپی از دیتابیس فعلی شما دانلود می‌شود.
            </small>
        </div>
    </div>

    <div class="card">
        <h5 class="card-header">تاریخچه پشتیبان‌گیری‌ها</h5>
        <div class="table-responsive text-nowrap">
            {% if history %}
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ردیف</th>
                        <th>شناسه</th>
                        <th>تاریخ</th>
                        <th>توضیحات</th>
                        <th>وضعیت</th>
                    </tr>
                </thead>
                <tbody class="table-border-bottom-0">
                    {% for record in history %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>
                            <code class="text-monospace text-primary fw-bold">{{ record.uid | safe }}</code>
                        </td>
                        <td>{{ record.date | jalali_date }}</td>
                        <td><span class="text-muted">{{ record.description | default:"بدون توضیح" }}</span></td>
                        <td><span class="badge bg-label-success">موفق</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="p-4 text-center text-muted">هنوز هیچ نسخه پشتیبانی ثبت نشده است!</div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block page_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const backupForm = document.getElementById('backup-form');
        const createBackupBtn = document.getElementById('create-backup-btn');
        const backupUrl = "{% url 'create_backup' %}";
        
        backupForm.addEventListener('submit', function(e) {
            e.preventDefault();
            createBackupBtn.disabled = true;
            createBackupBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> در حال ایجاد...';

            const description = document.getElementById('id_description').value;

            const requestBody = new URLSearchParams({
                'csrfmiddlewaretoken': document.querySelector('[name="csrfmiddlewaretoken"]').value,
                'description': description,
            });

            fetch(backupUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: requestBody
            })
            .then(response => response.json())
            .then(data => {
                createBackupBtn.disabled = false;
                createBackupBtn.innerHTML = '<i class="tf-icons bx bx-save me-1"></i> ایجاد پشتیبان';

                if (data.success) {
                    Swal.fire({
                        title: 'موفقیت',
                        text: data.message,
                        icon: 'success',
                        confirmButtonText: 'باشه'
                    }).then(() => {
                        window.location.reload();
                    });
                } else {
                    Swal.fire('خطا', data.message || 'خطای ناشناخته در سمت سرور.', 'error');
                }
            })
            .catch(error => {
                createBackupBtn.disabled = false;
                createBackupBtn.innerHTML = '<i class="tf-icons bx bx-save me-1"></i> ایجاد پشتیبان';
                Swal.fire('خطا', 'خطای ارتباطی. لطفاً اتصال شبکه را بررسی کنید.', 'error');
            });
        });
    });
</script>
{% endblock %}